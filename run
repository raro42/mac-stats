#!/bin/zsh
set -euo pipefail

root_dir="$(cd "$(dirname "$0")" && pwd)"

if [[ ! -d "$root_dir/src-tauri" ]]; then
  target_dir="${MAC_STATS_DIR:-$PWD/mac-stats}"
  if [[ ! -d "$target_dir/src-tauri" ]]; then
    if ! command -v git >/dev/null 2>&1; then
      echo "Error: git is required to clone the repo." >&2
      exit 1
    fi
    echo "Cloning repo to $target_dir ..."
    git clone --depth 1 https://github.com/raro42/mac-stats.git "$target_dir"
  fi
  root_dir="$target_dir"
fi

cd "$root_dir/src-tauri"

# Check for help flag first
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
  # Build first to ensure binary exists, then show help
  cargo build --release 2>/dev/null || true
  exec ./target/release/mac_stats --help
fi

# Check if first argument is "dev" for development mode
if [[ "${1:-release}" == "dev" ]]; then
  shift  # Remove "dev" from arguments
  # Pass remaining arguments to cargo run
  cargo run -- "$@"
else
  cargo build --release
  # Pass all arguments to the binary
  exec ./target/release/mac_stats "$@"
fi
